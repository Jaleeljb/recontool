<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phase 2 - Deep File Forensics</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        /* --- CORE STYLES --- */
        :root {
            --neon: #ff0055;
            --bg: #050505;
            --panel: rgba(20, 20, 20, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--bg);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- ANIMATED BACKGROUND --- */
        #grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            /* Ensure padding on all sides for small screens */
            padding: 10px;
        }

        /* --- HEADER --- */
        header {
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand h1 {
            font-size: 1.8em;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .brand span {
            color: var(--neon);
        }

        .subtitle {
            color: #666;
            font-size: 0.8em;
            letter-spacing: 1px;
        }

        /* --- UPLOAD ZONE --- */
        .upload-zone {
            border: 2px dashed #444;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--neon);
            background: rgba(255, 0, 85, 0.05);
        }

        .upload-icon {
            color: var(--neon);
            width: 48px;
            height: 48px;
            margin-bottom: 15px;
        }

        #fileInput {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* --- DASHBOARD GRID (DEFAULT: LARGE SCREEN) --- */
        .dashboard {
            display: none;
            grid-template-columns: 300px 1fr;
            /* Default sidebar + main content */
            gap: 20px;
            margin-top: 30px;
        }

        /* SIDEBAR (FILE STATS) */
        .file-stats {
            background: var(--panel);
            border: 1px solid #333;
            padding: 20px;
            height: fit-content;
        }

        .stat-item {
            margin-bottom: 15px;
            border-bottom: 1px solid #222;
            padding-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.8em;
        }

        .stat-value {
            font-size: 1.1em;
            word-break: break-all;
        }

        /* MAIN REPORT AREA */
        .report-panel {
            background: var(--panel);
            border: 1px solid #333;
            padding: 25px;
        }

        .verdict-banner {
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .verdict-clean {
            border-color: #0f0;
            background: rgba(0, 255, 0, 0.1);
        }

        .verdict-malicious {
            border-color: #f00;
            background: rgba(255, 0, 0, 0.1);
        }

        .finding-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            margin-bottom: 15px;
            padding: 15px;
            position: relative;
        }

        .finding-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .badge {
            padding: 3px 8px;
            font-size: 0.7em;
            font-weight: bold;
            border-radius: 3px;
        }

        .badge-high {
            background: #ff0055;
            color: white;
        }

        .badge-med {
            background: #ffaa00;
            color: black;
        }

        .code-snippet {
            background: #111;
            padding: 10px;
            border-left: 3px solid #666;
            font-family: monospace;
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
            white-space: pre-wrap;
        }

        .line-num {
            color: #555;
            margin-right: 10px;
            user-select: none;
        }

        /* LOADERS */
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spin {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* --- FIREWORKS ANIMATION (existing small DOM-based) --- */
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            opacity: 0;
            background: var(--neon);
            box-shadow: 0 0 5px var(--neon), 0 0 15px var(--neon);
            animation: explode 1s ease-out forwards;
        }

        @keyframes explode {
            0% {
                transform: scale(0.1);
                opacity: 1;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* --- HEX VIEWER (DEFAULT: LARGE SCREEN) --- */
        .hex-panel {
            grid-column: 1 / -1;
            background: #000;
            border: 1px solid #333;
            font-family: 'Courier New', monospace;
            padding: 15px;
            margin-top: 20px;
            position: relative;
        }

        .hex-grid {
            display: grid;
            grid-template-columns: 80px 1fr 150px;
            /* Offset, Bytes, Ascii (Large screen only) */
            gap: 15px;
            font-size: 0.85em;
            color: #444;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre;
        }

        .hex-offset {
            color: var(--neon);
            opacity: 0.7;
        }

        .hex-bytes {
            color: #ccc;
            letter-spacing: 2px;
        }

        .hex-ascii {
            color: #888;
            border-left: 1px solid #222;
            padding-left: 10px;
        }

        /* Scrollbar styling for the hex view */
        .hex-grid::-webkit-scrollbar {
            width: 8px;
        }

        .hex-grid::-webkit-scrollbar-track {
            background: #111;
        }

        .hex-grid::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        /* --- CRT OVERLAY --- */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0) 50%,
                    rgba(0, 0, 0, 0.1) 50%,
                    rgba(0, 0, 0, 0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
            animation: flicker 0.15s infinite;
        }

        /* Optional: Slight vignette to darken corners */
        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: 0 0 150px rgba(0, 0, 0, 0.9) inset;
            pointer-events: none;
            z-index: 998;
        }

        /* Simple flicker animation */
        @keyframes flicker {
            0% {
                opacity: 0.95;
            }

            50% {
                opacity: 0.92;
            }

            100% {
                opacity: 0.96;
            }
        }

        /* ======================================= */
        /* --- RESPONSIVENESS MEDIA QUERIES --- */
        /* ======================================= */

        /* Target tablets and smaller desktops (Max width 768px) */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .dashboard {
                grid-template-columns: 1fr;
                /* Single column layout */
                gap: 15px;
            }

            /* Push file stats to the top of the single column */
            .file-stats {
                order: 1;
            }

            /* Keep report panel below the stats */
            .report-panel {
                order: 2;
                padding: 15px;
            }

            /* Hex panel still spans full width, order 3 */
            .hex-panel {
                order: 3;
            }

            .upload-zone {
                padding: 30px 15px;
            }

            .brand h1 {
                font-size: 1.5em;
            }

            .verdict-banner {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }

            #verdict-score {
                margin-top: 10px;
                font-size: 1.5em !important;
            }

            /* Simplify Hex Dump for small screens */
            .hex-grid {
                /* Change to two columns: Offset and Hex Bytes */
                grid-template-columns: 60px 1fr;
                font-size: 0.7em;
                gap: 5px;
            }

            /* Hide the ASCII column on small screens */
            .hex-ascii,
            .hex-grid div:nth-child(3n) {
                display: none;
            }

            /* Adjust column span for the header line when ASCII is hidden */
            .hex-grid div:first-child {
                grid-column: 1 / span 2;
            }
        }

        /* Target mobile phones (Max width 480px) */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            /* The default header styles (display: flex, justify-content: space-between) 
               now correctly align the brand left and the button right. */
            /* Removed flex-direction: column and align-items: flex-start overrides. */

            .upload-zone h3 {
                font-size: 1em;
            }

            .upload-zone p {
                font-size: 0.7em !important;
            }

            .stat-value {
                font-size: 1em;
            }

            .finding-card {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div id="grid-bg"></div>

    <canvas id="fireworks-canvas"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none;"></canvas>

    <div class="container">
        <header>
            <div class="brand">
                <h1>DEEP<span>SCAN</span></h1>
                <p class="subtitle">AI-POWERED PHISHING & MALWARE FORENSICS</p>
            </div>
            <a href="index.html"
                style="color: #666; text-decoration: none; font-size: 0.8em; display: flex; align-items: center; gap: 5px; opacity: 0.8;">
                <i data-lucide="corner-down-left" style="width: 14px; height: 14px;"></i>
                RETURN to HOME
            </a>
        </header>

        <div class="upload-zone" id="dropZone">
            <input type="file" id="fileInput" onchange="handleFileSelect(this)">
            <i data-lucide="scan-line" class="upload-icon"></i>
            <h3>DRAG FILE or CLICK TO UPLOAD</h3>
            <p style="color: #666; margin-top: 10px; font-size: 0.9em;">
                SUPPORTS: PDF, DOCX, TXT, HTML, JS, PY, PNG, JPG<br>
                <span style="color: var(--neon); font-size: 0.8em;">
                </span>
            </p>
        </div>

        <div class="loader" id="loader">
            <i data-lucide="loader-2" class="spin" style="width: 40px; height: 40px; color: var(--neon);"></i>
            <p style="margin-top: 15px; letter-spacing: 2px;">EXTRACTING CONTENTS & ANALYZING VECTORS...</p>
            <p id="process-status" style="font-size: 0.8em; color: #666; margin-top: 5px;">Parsing binary data...</p>
        </div>

        <div class="dashboard" id="dashboard">

            <div class="file-stats">
                <h3><i data-lucide="file-code"></i> FILE META</h3>
                <br>
                <div class="stat-item">
                    <div class="stat-label">FILENAME</div>
                    <div class="stat-value" id="res-filename">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">SIZE</div>
                    <div class="stat-value" id="res-size">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">TYPE</div>
                    <div class="stat-value" id="res-type">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">SCAN TIMESTAMP</div>
                    <div class="stat-value" style="font-size: 0.8em; color: #888;" id="res-time">--</div>
                </div>
            </div>

            <div class="report-panel">
                <div id="verdict-box" class="verdict-banner">
                    <div>
                        <h2 id="verdict-title">ANALYZING...</h2>
                        <p id="verdict-desc" style="font-size: 0.9em; opacity: 0.8;">Waiting for AI judgment.</p>
                    </div>
                    <div id="verdict-score" style="font-size: 2em; font-weight: bold;">--</div>
                </div>

                <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                    DETECTION LOG <i data-lucide="microscope"></i>
                </h3>

                <div id="findings-container">
                </div>
            </div>

            <div class="hex-panel">
                <h3
                    style="color: #666; font-size: 0.8em; margin-bottom: 10px; border-bottom: 1px solid #222; padding-bottom: 5px;">
                    <i data-lucide="binary"></i> BINARY INSPECTION (FIRST 1KB)
                </h3>
                <div class="hex-grid" id="hex-view-content">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // 圷 YOU MUST PASTE YOUR GEMINI API KEY HERE 圷
        // Replace "YOUR_GEMINI_API_KEY_HERE" with your actual key to enable the scanner.
        const GEMINI_API_KEY = "AIzaSyCyZZo5mELKP7EELnE9DDP0y1QqojEoy2c";

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        lucide.createIcons();

        // --- 2. STATE ---
        let currentFileContent = ""; // Text content or Base64
        let isImage = false;

        // --- 3. FILE HANDLING ---
        function handleFileSelect(input) {
            const file = input.files[0];

            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE" || !GEMINI_API_KEY) {
                alert("Please open the code and paste your Gemini API Key into the 'GEMINI_API_KEY' variable to initialize the scanner.");
                return;
            }
            if (!file) return;

            // UI Reset
            document.querySelector('.upload-zone').style.display = 'none';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('res-filename').innerText = file.name;
            document.getElementById('res-size').innerText = (file.size / 1024).toFixed(2) + ' KB';
            document.getElementById('res-type').innerText = file.type || 'Unknown';
            document.getElementById('res-time').innerText = new Date().toLocaleString();

            // NEW: Call the Hex Dump generator
            generateHexDump(file);

            processFile(file, GEMINI_API_KEY);
        }

        async function processFile(file, apiKey) {
            const status = document.getElementById('process-status');

            try {
                // 1. EXTRACT CONTENT BASED ON TYPE
                if (file.type === "application/pdf") {
                    status.innerText = "Extracting text from PDF layers...";
                    currentFileContent = await extractTextFromPDF(file);
                    isImage = false;
                }
                else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
                    status.innerText = "Parsing DOCX XML structure...";
                    currentFileContent = await extractTextFromDOCX(file);
                    isImage = false;
                }
                else if (file.type.startsWith("image/")) {
                    status.innerText = "Encoding image for Vision API...";
                    currentFileContent = await fileToBase64(file);
                    isImage = true;
                }
                else {
                    // Default to text (Code, TXT, HTML, Logs)
                    status.innerText = "Reading raw text stream...";
                    currentFileContent = await readFileAsText(file);
                    isImage = false;
                }

                // 2. SEND TO GEMINI
                status.innerText = "Querying Neural Engine for patterns...";
                await analyzeWithGemini(currentFileContent, isImage, apiKey);

            } catch (e) {
                console.error(e);
                alert("Error processing file: " + e.message);
                location.reload();
            }
        }

        // --- 4. EXTRACTORS ---

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove Data URI prefix for API
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(" ");
                fullText += `[PAGE ${i}] ${pageText}\n`;
            }
            return fullText;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            return result.value;
        }

        // --- HEX DUMP GENERATOR (Responsive) ---
        function generateHexDump(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const buffer = e.target.result;
                const view = new DataView(buffer);
                const length = Math.min(view.byteLength, 1024); // Limit to first 1024 bytes
                let html = '';

                // Check screen size to simplify output
                const isSmallScreen = window.innerWidth <= 768;

                // Header
                if (isSmallScreen) {
                    // 2 columns for small screens (Offset + Hex)
                    html += `<div style="grid-column:1/-1; color:#555; margin-bottom:5px;">OFFSET   00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F</div>`;
                } else {
                    // 3 columns for large screens (Offset + Hex + ASCII)
                    html += `<div style="grid-column:1/-1; color:#555; margin-bottom:5px;">OFFSET   00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F   ASCII</div>`;
                }


                for (let i = 0; i < length; i += 16) {
                    // 1. Offset
                    const offset = i.toString(16).padStart(8, '0').toUpperCase();

                    // 2. Hex Bytes
                    let hex = '';
                    let ascii = '';

                    for (let j = 0; j < 16; j++) {
                        if (i + j < length) {
                            const byte = view.getUint8(i + j);
                            hex += byte.toString(16).padStart(2, '0').toUpperCase() + ' ';
                            // ASCII printable check
                            ascii += (byte >= 32 && byte <= 126) ? String.fromCharCode(byte) : '.';
                        } else {
                            hex += '   ';
                            ascii += ' ';
                        }
                    }

                    html += `<div class="hex-offset">${offset}</div>`;
                    html += `<div class="hex-bytes">${hex}</div>`;
                    // Only include ASCII if not on a screen smaller than 768px
                    if (!isSmallScreen) {
                        html += `<div class="hex-ascii">${ascii}</div>`;
                    }
                }

                document.getElementById('hex-view-content').innerHTML = html;
            };
            // Read only the required chunk for performance (1024 bytes)
            reader.readAsArrayBuffer(file.slice(0, 1024));
        }
        // --- END HEX DUMP GENERATOR ---

        // --- 5. AI ANALYSIS (No change) ---

        async function analyzeWithGemini(content, isImg, key) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`;

            // PROMPT ENGINEERING
            const systemPrompt = `
            You are a Cybersecurity Malware Analyst. Analyze the provided file content.
            Look for:
            1. Phishing: Suspicious URLs, deceptive login pages, urgency triggers.
            2. Malware: Obfuscated JavaScript/PowerShell, shellcode patterns, base64 encoded payloads.
            3. Anomalies: Hidden iframes, zero-width characters.

            Return a valid JSON object with this structure:
            {
                "verdict": "MALICIOUS" | "SUSPICIOUS" | "CLEAN",
                "riskScore": 0-100,
                "summary": "Short executive summary.",
                "findings": [
                    {
                        "type": "PHISHING" | "MALWARE" | "INFO",
                        "location": "Line number or Page number",
                        "snippet": "The suspicious code/text found",
                        "explanation": "Why this is dangerous"
                    }
                ]
            }
            If the file is an image, analyze visual elements (fake login buttons, QR codes).
            DO NOT output Markdown blocks. Output RAW JSON only.
            `;

            let userContentParts = [];

            if (isImg) {
                userContentParts = [
                    { text: "Scan this image for phishing elements or visual malware triggers." },
                    { inline_data: { mime_type: "image/jpeg", data: content } }
                ];
            } else {
                // Truncate large text files to prevent API 400 errors (approx token limit safety)
                const safeContent = content.substring(0, 30000);
                userContentParts = [{ text: "Scan this text content: \n" + safeContent }];
            }

            const payload = {
                contents: [{ parts: userContentParts }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.error) throw new Error(data.error.message);

            const rawText = data.candidates[0].content.parts[0].text;
            // Clean markdown if AI adds it
            const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            const result = JSON.parse(jsonStr);

            renderResults(result);
        }

        // --- 6. FIREWORKS LOGIC (No change) ---
        function createFirework(x, y) {
            const container = document.getElementById('fireworks-canvas');
            const numParticles = 20;

            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework';

                const angle = Math.random() * 360;
                const distance = Math.random() * 80 + 30;

                const endX = x + distance * Math.cos(angle * (Math.PI / 180));
                const endY = y + distance * Math.sin(angle * (Math.PI / 180));

                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;

                particle.style.setProperty('animation-duration', `${Math.random() * 0.5 + 0.5}s`);
                particle.style.setProperty('animation-delay', `${Math.random() * 0.1}s`);
                particle.style.setProperty('opacity', 1);

                particle.style.transition = `transform 1s ease-out, opacity 1s ease-out`;
                setTimeout(() => {
                    particle.style.transform = `translate(${endX - x}px, ${endY - y}px)`;
                    particle.style.opacity = 0;
                }, 10);

                container.appendChild(particle);

                setTimeout(() => particle.remove(), 1200);
            }
        }

        function triggerFireworks() {
            const container = document.getElementById('fireworks-canvas');
            container.style.display = 'block';

            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            createFirework(centerX - 100, centerY - 50);
            setTimeout(() => createFirework(centerX + 150, centerY + 100), 300);
            setTimeout(() => createFirework(centerX, centerY - 150), 600);

            setTimeout(() => {
                container.style.display = 'none';
            }, 1500);
        }

        // --- 6b. BIG FIRECRACKER (canvas-based, dramatic center explosion - No change) ---
        function triggerBigFirecracker() {
            const canvas = document.getElementById('fireworks-canvas');
            canvas.style.display = 'block';

            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            const cx = window.innerWidth / 2;
            const cy = window.innerHeight / 2;

            const PARTICLES = 250;
            const particles = [];
            const gravity = 0.06;
            const duration = 3000;
            const start = performance.now();

            function rand(min, max) {
                return Math.random() * (max - min) + min;
            }

            for (let i = 0; i < PARTICLES; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = rand(2, 9) * (0.6 + Math.random() * 0.9);
                const size = rand(1.2, 4.2);
                const hue = Math.floor(Math.random() * 360);
                particles.push({
                    x: cx,
                    y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    size: size,
                    life: 1,
                    color: `hsl(${hue}, 90%, ${rand(45, 65)}%)`,
                    fade: rand(0.015, 0.03),
                    sparkTimer: Math.floor(rand(0, 5))
                });
            }

            let flashAlpha = 1.2;

            function render(now) {
                const t = now - start;
                ctx.fillStyle = 'rgba(5, 5, 5, 0.2)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const grd = ctx.createRadialGradient(cx, cy, 10, cx, cy, Math.max(window.innerWidth, window.innerHeight) * 0.6);
                grd.addColorStop(0, `rgba(255,255,255,${Math.max(0, flashAlpha * 0.12)})`);
                grd.addColorStop(0.2, `rgba(255,255,255,${Math.max(0, flashAlpha * 0.06)})`);
                grd.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = grd;
                ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);

                if (flashAlpha > 0) {
                    ctx.beginPath();
                    ctx.fillStyle = `rgba(255,255,255,${Math.min(0.9, flashAlpha)})`;
                    ctx.arc(cx, cy, 48 * (1 + (1 - Math.max(0, flashAlpha))), 0, Math.PI * 2);
                    ctx.fill();
                    flashAlpha -= 0.05;
                }

                particles.forEach((p) => {
                    p.vy += gravity * (p.size * 0.03);
                    p.x += p.vx;
                    p.y += p.vy;

                    p.life -= p.fade;
                    if (p.life < 0) p.life = 0;

                    ctx.beginPath();
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life;
                    ctx.globalCompositeOperation = 'lighter';
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();

                    if (Math.random() < 0.04 || p.sparkTimer-- <= 0) {
                        ctx.beginPath();
                        ctx.fillStyle = `rgba(255,255,255,${Math.min(0.9, p.life)})`;
                        ctx.arc(p.x - p.vx * 0.2, p.y - p.vy * 0.2, Math.max(0.6, p.size * 0.4), 0, Math.PI * 2);
                        ctx.fill();
                    }
                });

                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1;


                if (t < duration && particles.some(p => p.life > 0.02)) {
                    requestAnimationFrame(render);
                } else {
                    const fadeStart = performance.now();
                    const fade = () => {
                        const ft = performance.now() - fadeStart;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        if (ft < 600) {
                            const g = ctx.createRadialGradient(cx, cy, 10, cx, cy, Math.max(window.innerWidth, window.innerHeight) * 0.5);
                            g.addColorStop(0, `rgba(255,200,120,${0.25 * (1 - ft / 600)})`);
                            g.addColorStop(1, 'rgba(0,0,0,0)');
                            ctx.fillStyle = g;
                            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
                            requestAnimationFrame(fade);
                        } else {
                            canvas.style.display = 'none';
                        }
                    };
                    requestAnimationFrame(fade);
                }
            }

            requestAnimationFrame(render);
        }

        // --- New: Celebratory sound (Web Audio API - No change) ---
        function playCelebration() {
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) return;
                const ctx = new AudioCtx();
                const master = ctx.createGain();
                master.gain.value = 0.0001;
                master.connect(ctx.destination);
                const now = ctx.currentTime;
                master.gain.exponentialRampToValueAtTime(0.8, now + 0.02);
                const notes = [523.25, 659.25, 783.99, 1046.50];
                let t = now;
                const noteDuration = 0.18;

                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, t);
                    const osc2 = ctx.createOscillator();
                    osc2.type = 'triangle';
                    osc2.frequency.setValueAtTime(freq * 0.5, t);
                    const g = ctx.createGain();
                    g.gain.setValueAtTime(0.0001, t);
                    g.gain.exponentialRampToValueAtTime(1.0, t + 0.01);
                    g.gain.exponentialRampToValueAtTime(0.0001, t + noteDuration);
                    osc.connect(g);
                    osc2.connect(g);
                    g.connect(master);
                    osc.start(t);
                    osc.stop(t + noteDuration);
                    osc2.start(t);
                    osc2.stop(t + noteDuration);
                    t += noteDuration * 0.95;
                });

                master.gain.exponentialRampToValueAtTime(0.0001, t + 0.25);
                setTimeout(() => {
                    try { ctx.close(); } catch (e) { /* ignore */ }
                }, (noteDuration * notes.length + 400));
            } catch (e) {
                console.warn('Celebration audio failed:', e);
            }
        }

        // --- 7. RENDERING (No change) ---

        function renderResults(data) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';

            const box = document.getElementById('verdict-box');
            const title = document.getElementById('verdict-title');
            const desc = document.getElementById('verdict-desc');
            const score = document.getElementById('verdict-score');

            title.innerText = data.verdict;
            desc.innerText = data.summary;
            score.innerText = data.riskScore + "/100";

            if (data.verdict === 'CLEAN') {
                box.className = 'verdict-banner verdict-clean';
                title.style.color = '#0f0';

                triggerFireworks();
                triggerBigFirecracker();

                playCelebration();
            } else {
                box.className = 'verdict-banner verdict-malicious';
                title.style.color = '#f00';
            }

            const container = document.getElementById('findings-container');
            container.innerHTML = '';

            if (data.findings && data.findings.length > 0) {
                data.findings.forEach(f => {
                    const sevColor = f.type === 'INFO' ? 'badge-med' : 'badge-high';

                    const card = document.createElement('div');
                    card.className = 'finding-card';
                    card.innerHTML = `
                        <div class="finding-header">
                            <span class="badge ${sevColor}">${f.type}</span>
                            <span style="color: #666; font-size: 0.8em;">LOC: ${f.location}</span>
                        </div>
                        <div style="margin-bottom: 5px; font-weight: bold; color: #eee;">${f.explanation}</div>
                        <div class="code-snippet">
                            <span class="line-num">></span>${f.snippet.replace(/</g, "&lt;")}
                        </div>
                    `;
                    container.appendChild(card);
                });
            } else {
                container.innerHTML = `<div style="text-align:center; color:#666; padding:20px;">No specific threats detected in the scanned sample.</div>`;
            }
        }

        // --- 8. INITIALIZATION ---
        window.onload = function () {
            lucide.createIcons();

            // Re-generate hex dump on resize for responsive layout changes
            window.addEventListener('resize', () => {
                const fileInput = document.getElementById('fileInput');
                if (fileInput.files.length > 0) {
                    generateHexDump(fileInput.files[0]);
                }
            });
        };
    </script>
</body>

</html>